<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Car on OSM</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>html,body,#map{height:100%;margin:0}</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- <script src="https://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/roslib/build/roslib.min.js"></script>
<script>
  // Connect to rosbridge on localhost:9090 (change host if needed)
  const ros = new ROSLIB.Ros({url: 'ws://localhost:9090'});

  // Leaflet map
  const map = L.map('map').setView([0,0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19,
    attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);

  const carIcon = L.circleMarker([0,0], {radius:6});
  carIcon.addTo(map);
  let first = true;

  // Subscribe to GeoJSON topic
  const carTopic = new ROSLIB.Topic({
    ros, name: '/osm_align/car_geojson', messageType: 'std_msgs/String'
  });

  // carTopic.subscribe(msg => {
  //   try {
  //     const f = JSON.parse(msg.data);
  //     const [lon, lat] = f.geometry.coordinates;
  //     carIcon.setLatLng([lat, lon]);
  //     if (first) { map.setView([lat, lon], 20); first = false; }
  //   } catch (e) { console.error(e); }
  // });

  let follow = true;  // start in follow mode

// map.on('dragstart', () => { follow = false; });  // stop following when user moves map
// map.on('dblclick', () => { follow = true; });    // double-click to re-enable follow

carTopic.subscribe(msg => {
  try {
    const f = JSON.parse(msg.data);
    const [lon, lat] = f.geometry.coordinates;
    carIcon.setLatLng([lat, lon]);
    if (first) { map.setView([lat, lon], 20); first = false; }

    if (follow) {
      map.setView([lat, lon], map.getZoom());
    }
  } catch (e) {
    console.error(e);
  }
});

</script>
</body>
</html>
